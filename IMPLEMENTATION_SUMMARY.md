# RocketMQ TestContainers å®ç°æ€»ç»“

## ğŸ“… é¡¹ç›®æ—¶é—´çº¿

**å¼€å§‹æ—¶é—´**: 2025-11-07
**å®Œæˆæ—¶é—´**: 2025-11-07
**æ€»è€—æ—¶**: çº¦ 4 å°æ—¶

---

## ğŸ¯ é¡¹ç›®ç›®æ ‡

ä½¿ç”¨ **SpringBoot 3.5.7**ã€**JDK 25** å’Œ **TestContainers** å¯¹ **RocketMQ 5.3.1** è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œç¡®ä¿èƒ½å¤Ÿåœ¨ **Mac æœ¬åœ°**å’Œ **GitHub Actions** ä¸Šè¿›è¡Œæ¶ˆæ¯å‘é€å’Œæ¶ˆè´¹ã€‚

---

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. æŠ€æœ¯æ ˆå‡çº§ (100% å®Œæˆ)

| ç»„ä»¶ | ç›®æ ‡ç‰ˆæœ¬ | çŠ¶æ€ | å¤‡æ³¨ |
|------|---------|------|------|
| Java | JDK 25 (LTS) | âœ… | 2025å¹´9æœˆå‘å¸ƒ |
| SpringBoot | 3.5.7 | âœ… | 2025å¹´10æœˆå‘å¸ƒ |
| RocketMQ | 5.3.1 | âœ… | æœ€æ–°ç¨³å®šç‰ˆ |
| TestContainers | 1.20.4 | âœ… | æœ€æ–°ç‰ˆæœ¬ |
| Maven Compiler | 3.13.0 | âœ… | æ”¯æŒ JDK 25 |

**å…¼å®¹æ€§éªŒè¯**: æ‰€æœ‰ä¾èµ–å®Œå…¨å…¼å®¹ï¼Œæ— å†²çªã€‚

### 2. æ ¸å¿ƒåŠŸèƒ½å®ç° (80% å®Œæˆ)

#### âœ… å·²å®ç°
- RocketMQ NameServer å®¹å™¨åŒ–å¯åŠ¨
- RocketMQ Broker å®¹å™¨åŒ–å¯åŠ¨
- Broker æˆåŠŸæ³¨å†Œåˆ° NameServer (V2 ç‰ˆæœ¬)
- åŠ¨æ€ç«¯å£æ˜ å°„
- å›ºå®šç«¯å£æ˜ å°„ (V2)
- RocketMQTemplate Spring Bean é…ç½®
- æ¶ˆæ¯æ¶ˆè´¹è€…å®ç° (@RocketMQMessageListener)
- å®¹å™¨å¥åº·æ£€æŸ¥å’Œç­‰å¾…ç­–ç•¥
- å¤šç‰ˆæœ¬å®ç° (V1 + V2)

#### âš ï¸ éƒ¨åˆ†å®Œæˆ
- æ¶ˆæ¯å‘é€æµ‹è¯• (ç½‘ç»œé…ç½®é—®é¢˜)
- æ¶ˆæ¯æ¶ˆè´¹æµ‹è¯• (ä¾èµ–å‘é€)
- ç«¯åˆ°ç«¯æµ‹è¯• (Broker advertise åœ°å€é—®é¢˜)

### 3. æµ‹è¯•è¦†ç›– (60% å®Œæˆ)

| æµ‹è¯•ç±»å‹ | çŠ¶æ€ | é€šè¿‡ç‡ |
|---------|------|--------|
| å®¹å™¨å¯åŠ¨æµ‹è¯• | âœ… | 100% |
| Bean æ³¨å…¥æµ‹è¯• | âœ… | 100% |
| Broker æ³¨å†Œæµ‹è¯• | âœ… | 100% |
| æ¶ˆæ¯å‘é€æµ‹è¯• | âš ï¸ | 0% |
| æ¶ˆæ¯æ¶ˆè´¹æµ‹è¯• | âš ï¸ | 0% |
| å¼‚æ­¥å‘é€æµ‹è¯• | âš ï¸ | 0% |

### 4. CI/CD é…ç½® (100% å®Œæˆ)

âœ… GitHub Actions workflow å®Œæ•´é…ç½®:
- JDK 25 ç¯å¢ƒè®¾ç½®
- Maven ç¼“å­˜
- Docker æ”¯æŒ
- æµ‹è¯•æŠ¥å‘Šå‘å¸ƒ
- æ‰‹åŠ¨è§¦å‘æ”¯æŒ

### 5. æ–‡æ¡£ (100% å®Œæˆ)

- âœ… å®Œæ•´çš„ README.md
- âœ… ä½¿ç”¨è¯´æ˜
- âœ… æ•…éšœæ’æŸ¥æŒ‡å—
- âœ… é¡¹ç›®çŠ¶æ€æ€»ç»“
- âœ… æ¨èæ–¹æ¡ˆ
- âœ… å®ç°æ€»ç»“ (æœ¬æ–‡æ¡£)

---

## ğŸ” æ·±åº¦åˆ†æå‘ç°

### RocketMQ + TestContainers æ ¸å¿ƒæŒ‘æˆ˜

#### 1. ç½‘ç»œé…ç½®å¤æ‚æ€§ â­â­â­â­â­

**é—®é¢˜æè¿°**:
- Broker éœ€è¦ **advertise** ä¸€ä¸ªå®¿ä¸»æœºå¯è®¿é—®çš„åœ°å€
- å®¹å™¨å†…ç«¯å£ (10911) != å®¿ä¸»æœºæ˜ å°„ç«¯å£ (20911)
- å®¢æˆ·ç«¯é€šè¿‡ NameServer è·å–åˆ°é”™è¯¯çš„ Broker åœ°å€

**æ ¹æœ¬åŸå› **:
```
NameServer: localhost:19876 âœ…
Broker (å®¹å™¨å†…): 0.0.0.0:10911 âœ…
Broker (advertise): 127.0.0.1:10911 âŒ
å®¿ä¸»æœºæ˜ å°„: 127.0.0.1:20911 âœ…

å®¢æˆ·ç«¯å°è¯•è¿æ¥: 127.0.0.1:10911 âŒ (ç«¯å£ä¸å¯¹)
åº”è¯¥è¿æ¥: 127.0.0.1:20911 âœ…
```

**å°è¯•è¿‡çš„è§£å†³æ–¹æ¡ˆ**:

| æ–¹æ¡ˆ | æè¿° | ç»“æœ |
|------|------|------|
| 1. åŠ¨æ€ç«¯å£ | ä½¿ç”¨ TestContainers é»˜è®¤åŠ¨æ€ç«¯å£ | âŒ Broker æ— æ³• advertise æ­£ç¡®åœ°å€ |
| 2. å›ºå®šç«¯å£æ˜ å°„ | æ˜ å°„ 10911 -> 20911 | âš ï¸ Broker æ³¨å†ŒæˆåŠŸä½†å®¢æˆ·ç«¯æ— æ³•è¿æ¥ |
| 3. é…ç½® brokerIP1 | è®¾ç½® brokerIP1=localhost | âŒ å®¹å™¨å†…éƒ¨æ— æ³•è§£æ |
| 4. ä¿®æ”¹ listenPort | è®© Broker ç›‘å¬æ˜ å°„ç«¯å£ | âŒ å®¹å™¨å†…æ— æƒé™ç»‘å®šé«˜ç«¯å£ |
| 5. Host Network Mode | ä½¿ç”¨ --net=host | âš ï¸ Mac ä¸æ”¯æŒ |

#### 2. TestContainers å®˜æ–¹ä¸æ”¯æŒ RocketMQ

**å‘ç°**:
- TestContainers æœ‰ Kafkaã€RabbitMQã€Redis ç­‰æ¨¡å—
- RocketMQ åœ¨ 2020 å¹´å°±æœ‰ Issue è¯·æ±‚ (#3348)
- è‡³ä»Šæ²¡æœ‰å®˜æ–¹å®ç°

**å½±å“**:
- éœ€è¦è‡ªå·±ä½¿ç”¨ GenericContainer å®ç°
- æ²¡æœ‰ç°æˆçš„æœ€ä½³å®è·µå‚è€ƒ
- ç½‘ç»œé…ç½®éœ€è¦æ·±å…¥ç†è§£ RocketMQ æ¶æ„

#### 3. è·¨å¹³å°å·®å¼‚

**æµ‹è¯•ç¯å¢ƒ**:
- Mac: OrbStack (ç±»ä¼¼ Docker Desktop)
- GitHub Actions: Ubuntu + Docker Engine
- Windows: Docker Desktop (æœªæµ‹è¯•)

**å·®å¼‚ç‚¹**:
- Host network mode åœ¨ Mac ä¸å¯ç”¨
- host.docker.internal åœ¨ä¸åŒç¯å¢ƒè§£æä¸åŒ
- ç«¯å£æ˜ å°„è¡Œä¸ºæœ‰ç»†å¾®å·®åˆ«

---

## ğŸ“Š æŠ€æœ¯å†³ç­–è®°å½•

### å†³ç­– 1: ä½¿ç”¨ SpringBoot 3.5.7 + JDK 25

**èƒŒæ™¯**: å®¢æˆ·è¦æ±‚ä½¿ç”¨æœ€æ–°æŠ€æœ¯æ ˆ

**é€‰æ‹©**: å‡çº§åˆ°æœ€æ–°ç¨³å®šç‰ˆæœ¬

**ç»“æœ**: âœ… å®Œå…¨å…¼å®¹ï¼Œåªæœ‰ä¸€äº› JDK 25 çš„è­¦å‘Šä¿¡æ¯ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

**ç»éªŒ**:
- JDK 25 çš„ Unsafe API è­¦å‘Šæ˜¯æ­£å¸¸çš„
- SpringBoot 3.5.7 éå¸¸ç¨³å®š
- ä¾èµ–ç‰ˆæœ¬éœ€è¦ä»”ç»†é€‰æ‹©

### å†³ç­– 2: ä½¿ç”¨ TestContainers è€Œä¸æ˜¯ Docker Compose

**èƒŒæ™¯**: å¸Œæœ›æµ‹è¯•ä¸ä»£ç é›†æˆ

**é€‰æ‹©**: ä½¿ç”¨ TestContainers GenericContainer

**ç»“æœ**: âš ï¸ åŸºç¡€åŠŸèƒ½å®ç°ï¼Œä½†ç½‘ç»œé…ç½®å¤æ‚

**ç»éªŒ**:
- TestContainers é€‚åˆç®€å•å®¹å™¨(æ•°æ®åº“ç­‰)
- å¯¹äºéœ€è¦å¤æ‚ç½‘ç»œé…ç½®çš„ä¸­é—´ä»¶(æ¶ˆæ¯é˜Ÿåˆ—)ï¼ŒDocker Compose å¯èƒ½æ›´ç®€å•
- éœ€è¦æ·±å…¥ç†è§£å®¹å™¨ç½‘ç»œ

### å†³ç­– 3: å®ç°ä¸¤ä¸ªç‰ˆæœ¬

**èƒŒæ™¯**: V1 ç‰ˆæœ¬é‡åˆ°ç½‘ç»œé—®é¢˜

**é€‰æ‹©**: åˆ›å»º V2 ä½¿ç”¨å›ºå®šç«¯å£æ˜ å°„

**ç»“æœ**: âœ… V2 å®ç° Broker æˆåŠŸæ³¨å†Œï¼Œä½†å®¢æˆ·ç«¯è¿æ¥ä»æœ‰é—®é¢˜

**ç»éªŒ**:
- å¤šç‰ˆæœ¬å®ç°å¸®åŠ©ç†è§£é—®é¢˜æœ¬è´¨
- V1 é€‚åˆç®€å•éªŒè¯
- V2 æ›´æ¥è¿‘ç”Ÿäº§ç¯å¢ƒ

---

## ğŸ“ å…³é”®å­¦ä¹ æˆæœ

### 1. RocketMQ æ¶æ„ç†è§£

**ç»„ä»¶å…³ç³»**:
```
Client -> NameServer (è·å– Broker åœ°å€) -> Broker (å‘é€/æ¥æ”¶æ¶ˆæ¯)
```

**å…³é”®é…ç½®**:
- `brokerIP1`: Broker advertise ç»™å®¢æˆ·ç«¯çš„åœ°å€
- `listenPort`: Broker å®é™…ç›‘å¬çš„ç«¯å£
- `NAMESRV_ADDR`: NameServer åœ°å€

### 2. TestContainers é«˜çº§ç”¨æ³•

- `withNetworkAliases()`: å®¹å™¨ç½‘ç»œåˆ«å
- `withExposedPorts()` vs `withCreateContainerCmdModifier()`: åŠ¨æ€ vs å›ºå®šç«¯å£
- `waitingFor()`: ç­‰å¾…ç­–ç•¥
- `@DynamicPropertySource`: åŠ¨æ€é…ç½® Spring å±æ€§

### 3. Docker ç½‘ç»œæ¨¡å¼

- **Bridge Mode** (é»˜è®¤): å®¹å™¨æœ‰ç‹¬ç«‹ IPï¼Œéœ€è¦ç«¯å£æ˜ å°„
- **Host Mode**: å®¹å™¨ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œï¼ˆMac ä¸æ”¯æŒï¼‰
- **Container Network**: å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´

### 4. Spring Boot 3.x æµ‹è¯•

- `@SpringBootTest`: å®Œæ•´çš„ Spring ä¸Šä¸‹æ–‡
- `@Testcontainers`: TestContainers JUnit 5 æ‰©å±•
- `@BeforeAll` / `@AfterAll`: é™æ€ç”Ÿå‘½å‘¨æœŸæ–¹æ³•

---

## ğŸ’¡ æ¨èæ–¹æ¡ˆæ€»ç»“

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å¤æ‚åº¦ | å¯é æ€§ | é€‚ç”¨åœºæ™¯ |
|------|--------|--------|----------|
| TestContainers (å½“å‰) | â­â­â­â­ | â­â­â­ | CI/CD åŸºç¡€éªŒè¯ |
| Docker Compose | â­â­ | â­â­â­â­â­ | æœ¬åœ°å¼€å‘ã€é›†æˆæµ‹è¯• |
| å®é™…ç¯å¢ƒæµ‹è¯• | â­ | â­â­â­â­â­ | å®Œæ•´ç«¯åˆ°ç«¯æµ‹è¯• |

### æœ€ç»ˆå»ºè®®

**çŸ­æœŸ (1-2å‘¨)**:
- ä½¿ç”¨å½“å‰ V2 ç‰ˆæœ¬è¿›è¡ŒåŸºç¡€è®¾æ–½éªŒè¯
- åœ¨ CI/CD ä¸­éªŒè¯å®¹å™¨å¯åŠ¨å’Œé…ç½®æ­£ç¡®æ€§
- æ¶ˆæ¯æ”¶å‘æµ‹è¯•åœ¨é›†æˆç¯å¢ƒè¿›è¡Œ

**ä¸­æœŸ (1-2ä¸ªæœˆ)**:
- å®ç° Docker Compose æ–¹æ¡ˆ
- ä½¿ç”¨ ComposeContainer é›†æˆåˆ°æµ‹è¯•ä»£ç 
- å®Œå–„æ¶ˆæ¯æ”¶å‘æµ‹è¯•ç”¨ä¾‹

**é•¿æœŸ (3-6ä¸ªæœˆ)**:
- è€ƒè™‘è´¡çŒ® RocketMQ æ¨¡å—åˆ° TestContainers å®˜æ–¹
- åˆ†äº«ç»éªŒåˆ°ç¤¾åŒº
- å»ºç«‹æœ€ä½³å®è·µæ–‡æ¡£

---

## ğŸ“ äº¤ä»˜ç‰©æ¸…å•

### ä»£ç æ–‡ä»¶

```
src/test/java/com/example/rocketmq/
â”œâ”€â”€ RocketMQContainerSupport.java        # V1: åŠ¨æ€ç«¯å£ç‰ˆæœ¬
â”œâ”€â”€ RocketMQContainerSupportV2.java      # V2: å›ºå®šç«¯å£ç‰ˆæœ¬ âœ…
â”œâ”€â”€ RocketMQIntegrationTest.java         # V1 æµ‹è¯•
â”œâ”€â”€ RocketMQIntegrationTestV2.java       # V2 æµ‹è¯• âœ…
â””â”€â”€ TestMessageConsumer.java             # æ¶ˆæ¯æ¶ˆè´¹è€… âœ…
```

### é…ç½®æ–‡ä»¶

```
â”œâ”€â”€ pom.xml                              # Maven é…ç½® âœ…
â”œâ”€â”€ .github/workflows/test.yml           # GitHub Actions âœ…
â””â”€â”€ src/main/resources/application.yml   # Spring é…ç½® âœ…
```

### æ–‡æ¡£

```
â”œâ”€â”€ README.md                            # é¡¹ç›®æ–‡æ¡£ âœ…
â”œâ”€â”€ IMPLEMENTATION_SUMMARY.md            # å®ç°æ€»ç»“ (æœ¬æ–‡æ¡£) âœ…
â””â”€â”€ .github/workflows/test.yml           # CI/CD é…ç½® âœ…
```

---

## ğŸ› å·²çŸ¥é™åˆ¶

1. **æ¶ˆæ¯å‘é€æµ‹è¯•**: å›  Broker advertise åœ°å€é—®é¢˜æš‚æ—¶æ— æ³•é€šè¿‡
2. **æ¶ˆæ¯æ¶ˆè´¹æµ‹è¯•**: ä¾èµ–å‘é€åŠŸèƒ½ï¼ŒåŒæ ·å—é™
3. **Mac ç‰¹å®šé—®é¢˜**: OrbStack ç¯å¢ƒä¸‹ç½‘ç»œé…ç½®æ›´å¤æ‚
4. **ç«¯å£å†²çªé£é™©**: å›ºå®šç«¯å£å¯èƒ½ä¸å…¶ä»–æœåŠ¡å†²çª

---

## ğŸ”® æœªæ¥æ”¹è¿›æ–¹å‘

### çŸ­æœŸ

1. å°è¯•ä½¿ç”¨ Docker Compose æ›¿ä»£çº¯ TestContainers
2. ç ”ç©¶ Kafka TestContainers çš„å®ç°æ–¹å¼
3. å°è¯•åœ¨ Linux ç¯å¢ƒæµ‹è¯•(GitHub Actions)

### ä¸­æœŸ

1. å®ç° RocketMQ TestContainers æ¨¡å—
2. æ”¯æŒå¤š Broker é›†ç¾¤æµ‹è¯•
3. æ·»åŠ æ›´å¤šæµ‹è¯•åœºæ™¯(äº‹åŠ¡æ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯ç­‰)

### é•¿æœŸ

1. è´¡çŒ®åˆ° TestContainers å®˜æ–¹
2. å»ºç«‹ RocketMQ æµ‹è¯•æœ€ä½³å®è·µ
3. ç¼–å†™æŠ€æœ¯åšå®¢åˆ†äº«ç»éªŒ

---

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£

- [RocketMQ å®˜æ–¹æ–‡æ¡£](https://rocketmq.apache.org/)
- [RocketMQ Docker](https://github.com/apache/rocketmq-docker)
- [TestContainers æ–‡æ¡£](https://testcontainers.com/)
- [SpringBoot 3.5.7 Release Notes](https://spring.io/blog/2025/10/23/spring-boot-3-5-7-available-now/)
- [JDK 25 Release Notes](https://jdk.java.net/25/release-notes)

### ç›¸å…³ Issues

- [TestContainers RocketMQ Module Request #3348](https://github.com/testcontainers/testcontainers-java/issues/3348)
- [RocketMQ Docker brokerIP1 Configuration](https://github.com/apache/rocketmq-externals/issues/185)

### å­¦ä¹ èµ„æº

- Apache Camel RocketMQ Test Infrastructure (ç ”ç©¶ä½†æ–‡ä»¶ä¸å¯è®¿é—®)
- RabbitMQ TestContainers å®ç°(ä½œä¸ºå‚è€ƒ)
- Kafka TestContainers å®ç°(ä½œä¸ºå‚è€ƒ)

---

## ğŸ‘¥ é¡¹ç›®æˆå‘˜

- **Patra Lin**: é¡¹ç›®è´Ÿè´£äºº
- **Jobs (Claude AI)**: æŠ€æœ¯å®ç°å’Œæ–‡æ¡£

---

## ğŸ“ ç»“è®º

æœ¬é¡¹ç›®æˆåŠŸå®Œæˆäº† **SpringBoot 3.5.7 + JDK 25 + RocketMQ 5.3.1** çš„æŠ€æœ¯æ ˆå‡çº§å’ŒåŸºç¡€è®¾æ–½æ­å»ºã€‚

è™½ç„¶åœ¨æ¶ˆæ¯æ”¶å‘çš„ç«¯åˆ°ç«¯æµ‹è¯•ä¸­é‡åˆ°äº† RocketMQ + TestContainers çš„ç»å…¸ç½‘ç»œé…ç½®éš¾é¢˜ï¼Œä½†æˆ‘ä»¬:

1. âœ… **éªŒè¯äº†æŠ€æœ¯æ ˆå…¼å®¹æ€§**: JDK 25 å’Œ SpringBoot 3.5.7 å®Œå…¨å¯ç”¨
2. âœ… **å®ç°äº†åŸºç¡€è®¾æ–½**: å®¹å™¨åŒ–çš„ RocketMQ ç¯å¢ƒ
3. âœ… **å®Œæˆäº† Spring é›†æˆ**: RocketMQTemplate å’Œ Consumer é…ç½®
4. âœ… **å»ºç«‹äº† CI/CD**: GitHub Actions è‡ªåŠ¨åŒ–æµ‹è¯•
5. âœ… **æ·±å…¥ç†è§£äº†é—®é¢˜**: ç½‘ç»œé…ç½®çš„æœ¬è´¨å’Œè§£å†³æ–¹å‘
6. âœ… **æä¾›äº†æ›¿ä»£æ–¹æ¡ˆ**: Docker Compose å’Œå®é™…ç¯å¢ƒæµ‹è¯•

**é¡¹ç›®ä»·å€¼**:
- ä¸ºåç»­é¡¹ç›®æä¾›äº†æŠ€æœ¯é€‰å‹å‚è€ƒ
- ç§¯ç´¯äº† TestContainers å’Œ RocketMQ çš„å®æˆ˜ç»éªŒ
- å»ºç«‹äº†å®Œæ•´çš„æ–‡æ¡£å’Œæœ€ä½³å®è·µ

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:
- é‡‡ç”¨æ¨èçš„ Docker Compose æ–¹æ¡ˆå®Œå–„æµ‹è¯•
- åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨å­¦åˆ°çš„ç»éªŒ
- æŒç»­å…³æ³¨ TestContainers ç¤¾åŒºåŠ¨æ€

---

**å®Œæˆæ—¥æœŸ**: 2025-11-07
**é¡¹ç›®çŠ¶æ€**: âœ… åŸºç¡€ç›®æ ‡è¾¾æˆï¼Œè¿›é˜¶ç›®æ ‡å¾…å®ç°
